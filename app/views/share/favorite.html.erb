<!-- app/views/share/favorite.html.erb -->
<div class="share-page">

  <!-- Main restaurant card -->
  <section class="card">
    <h2 class="activity-title">
      ‚ú® Check out this gem!
    </h2>

    <% if @name.present? %>
      <p class="rest-name"><%= @name %></p>
    <% end %>

    <% if @price_range.present? %>
      <div style="margin-bottom: 12px;">
        <span class="rest-price"><%= @price_range %></span>
      </div>
    <% end %>

    <% if @address.present? %>
      <div class="info-banner">
        <div class="info-banner-icon">üìç</div>
        <div class="info-banner-text">
          <%= @address %>
        </div>
      </div>
    <% end %>

    <% if @hours.present? %>
      <div class="info-banner" style="margin-top: 12px;">
        <div class="info-banner-icon">üïí</div>
        <div class="info-banner-text">
          <%= @hours %>
        </div>
      </div>
    <% end %>

    <!-- Action buttons -->
    <div class="action-buttons">
      <% if @latitude.present? && @longitude.present? %>
        <a
          href="https://maps.apple.com/?ll=<%= @latitude %>,<%= @longitude %>&q=<%= CGI.escape(@name) %>"
          target="_blank"
          rel="noopener"
          class="glass-button primary"
        >
          üó∫Ô∏è Get Directions
        </a>
      <% elsif @address.present? %>
        <a
          href="https://maps.apple.com/?address=<%= CGI.escape(@address) %>"
          target="_blank"
          rel="noopener"
          class="glass-button primary"
        >
          üó∫Ô∏è Get Directions
        </a>
      <% end %>

      <% if @website.present? %>
        <a href="<%= @website %>" target="_blank" rel="noopener" class="glass-button">
          üåê Website
        </a>
      <% end %>

      <a id="shareFavorite" class="glass-button">
        üîó Share
      </a>
    </div>
  </section>

  <!-- Photos section -->
  <% if @photos.present? && @photos.any? %>
    <div class="card">
      <h2>üì∏ Photos</h2>
      <div class="photos-grid">
        <% @photos.take(6).each do |photo| %>
          <% photo_url = photo["photo_url"] || photo[:photo_url] %>
          <% if photo_url.present? %>
            <div class="photo-item">
              <img src="<%= photo_url %>" alt="Photo of <%= @name %>" loading="lazy">
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- About this place section -->
  <% if @description.present? || @reason.present? %>
    <div class="card">
      <h2>üí¨ About this place</h2>

      <% if @description.present? %>
        <p class="rest-desc"><%= @description %></p>
      <% end %>

      <% if @reason.present? %>
        <div class="reason-box">
          <p class="reason-label">Why this was saved:</p>
          <p class="rest-desc reason-text"><em>"<%= @reason %>"</em></p>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Reviews section -->
  <% if @reviews.present? && @reviews.any? %>
    <div class="card">
      <h2>‚≠ê Reviews</h2>
      <% @reviews.take(3).each do |review| %>
        <div class="review-item">
          <div class="review-header">
            <span class="review-author"><%= review["author_name"] || review[:author_name] %></span>
            <span class="review-rating">
              <% rating = (review["rating"] || review[:rating]).to_i %>
              <% rating.times do %>‚≠ê<% end %>
            </span>
          </div>
          <% review_text = review["text"] || review[:text] %>
          <% if review_text.present? %>
            <p class="review-text">
              <%= review_text.length > 200 ? "#{review_text[0..197]}..." : review_text %>
            </p>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Call to action -->
  <div class="card">
    <h2>üíú Shared from Voxxy</h2>
    <p class="rest-desc">
      Your social discovery app for finding and sharing amazing places with friends.
    </p>

    <div class="action-buttons">
      <a href="https://www.heyvoxxy.com" target="_blank" rel="noopener" class="glass-button primary">
        Learn About Voxxy
      </a>
    </div>
  </div>
</div>

<!-- Toast notification div -->
<div id="toast" class="toast"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Try to open app immediately on mobile
    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
      const deepLink = 'voxxy://share/favorite/<%= @favorite_id %>?name=<%= CGI.escape(@name.to_s) %>&address=<%= CGI.escape(@address.to_s) %>&lat=<%= @latitude %>&lng=<%= @longitude %>';

      // Attempt to open the app
      window.location = deepLink;

      // Fallback to App Store/Play Store after timeout
      setTimeout(() => {
        if (document.hidden) return; // App opened successfully

        // Show app store links (update with your actual app store URLs)
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        if (isIOS) {
          // Uncomment and add your App Store URL when ready
          // window.location = 'https://apps.apple.com/app/your-app-id';
        } else {
          // Uncomment and add your Play Store URL when ready
          // window.location = 'https://play.google.com/store/apps/details?id=your.package.name';
        }
      }, 2000);
    }

    // Share button with toast notification
    const shareBtn = document.getElementById('shareFavorite');
    if (shareBtn) {
      shareBtn.addEventListener('click', function() {
        if (navigator.share) {
          // Use Web Share API if available
          navigator.share({
            title: '<%= @name %>',
            text: 'Check out <%= @name %> on Voxxy!',
            url: window.location.href
          })
          .then(() => {
            showToast('‚úÖ Shared successfully!');
          })
          .catch((error) => {
            if (error.name !== 'AbortError') {
              // Fallback to clipboard
              copyToClipboard();
            }
          });
        } else {
          // Fallback to clipboard
          copyToClipboard();
        }
      });
    }

    function copyToClipboard() {
      navigator.clipboard.writeText(window.location.href)
        .then(() => {
          showToast('‚úÖ Link copied to clipboard!');
        })
        .catch(() => {
          showToast('‚ùå Could not copy link');
        });
    }

    // Toast notification function
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  });
</script>
