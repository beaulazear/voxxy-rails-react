<!-- app/views/activities/share.html.erb -->
<div class="share-page">
  
  <!-- Main activity card with gradient title -->
  <section class="card">
    <h2 class="activity-title">
      <%= @activity.emoji %> <%= @activity.activity_name %>
    </h2>
    
    <% if @activity.date_day.present? && @activity.date_time.present? %>
      <!-- Countdown first -->
      <div class="countdown-label">â° Event starts in</div>
      <div
        id="countdown"
        data-day="<%= @activity.date_day %>"
        data-hour="<%= @activity.date_time.hour %>"
        data-minute="<%= @activity.date_time.min %>"
        data-second="<%= @activity.date_time.sec %>"
      ></div>
      
      <!-- Event date banner after countdown -->
      <div class="info-banner">
        <div class="info-banner-icon">ğŸ—“</div>
        <div class="info-banner-text">
          <%= @activity.date_day.strftime("%A, %B %-d, %Y") %> at <%= @activity.date_time.strftime("%I:%M %p") %>
        </div>
      </div>
      
      <!-- Action buttons -->
      <div class="action-buttons">
        <a
          href="<%= calendar_activity_path(@activity, format: :ics) %>"
          class="glass-button primary"
          download="<%= @activity.activity_name.parameterize %>.ics"
        >
          ğŸ“… Add to Calendar
        </a>
        <a id="sharePlan" class="glass-button">
          ğŸ”— Share
        </a>
      </div>
    <% end %>
  </section>
  
  <!-- Final restaurant/venue selection -->
  <% if (pinned = @activity.pinned_activities.find_by(selected: true)) %>
    <div class="card">
      <h2>ğŸ“ Location Details</h2>
      <p class="rest-name"><%= pinned.title %></p>
      
      <% if pinned.description.present? %>
        <p class="rest-desc"><%= pinned.description %></p>
      <% end %>
      
      <p class="rest-address">ğŸ“Œ <%= pinned.address %></p>
      
      <% if pinned.price_range.present? %>
        <span class="rest-price"><%= pinned.price_range %></span>
      <% end %>
      
      <div class="action-buttons">
        <% if pinned.website.present? %>
          <a href="<%= pinned.website %>" target="_blank" rel="noopener" class="glass-button">
            ğŸŒ Website
          </a>
        <% end %>
        <% if pinned.address.present? %>
          <a
            href="https://maps.google.com?q=<%= CGI.escape(pinned.address) %>"
            target="_blank" rel="noopener"
            class="glass-button primary"
          >
            ğŸ—ºï¸ Directions
          </a>
        <% end %>
      </div>
    </div>
  <% end %>
  
  <!-- Organizer message -->
  <% if @activity.welcome_message.present? %>
    <div class="card">
      <h2>ğŸ’¬ Message from Organizer</h2>
      <p class="rest-desc"><%= @activity.welcome_message %></p>
    </div>
  <% end %>
  
  <!-- Attendees -->
  <div class="card">
    <h2>ğŸ‘¥ Who's Coming</h2>
    <ul class="attendee-pills">
      <li class="pill">ğŸ‘‘ <%= @activity.user.name %> (Host)</li>
      <% @activity.participants.each do |p| %>
        <% first = p.name.split(" ").first %>
        <li class="pill">âœ“ <%= first %></li>
      <% end %>
    </ul>
  </div>
</div>

<!-- Toast notification div -->
<div id="toast" class="toast"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Countdown timer
    const el = document.getElementById('countdown');
    if (el) {
      const [year, month, day] = el.dataset.day.split('-').map(Number);
      const hour   = parseInt(el.dataset.hour,   10);
      const minute = parseInt(el.dataset.minute, 10);
      const second = parseInt(el.dataset.second, 10);
      
      const target = new Date(year, month - 1, day, hour, minute, second).getTime();
      
      function updateCountdown() {
        const diff = target - Date.now();
        if (diff <= 0) {
          el.innerHTML = '<div class="cd-card"><strong>ğŸ‰</strong><small>Started!</small></div>';
          clearInterval(timer);
          return;
        }
        const days  = Math.floor(diff / (1000*60*60*24));
        const hours = Math.floor((diff / (1000*60*60)) % 24);
        const mins  = Math.floor((diff / (1000*60))     % 60);
        const secs  = Math.floor((diff / 1000)          % 60);
        const pad = n => String(n).padStart(2,'0');
        
        el.innerHTML =
          `<span class="cd-card"><strong>${pad(days)}</strong><small>d</small></span>` +
          `<span>:</span>` +
          `<span class="cd-card"><strong>${pad(hours)}</strong><small>h</small></span>` +
          `<span>:</span>` +
          `<span class="cd-card"><strong>${pad(mins)}</strong><small>m</small></span>` +
          `<span>:</span>` +
          `<span class="cd-card"><strong>${pad(secs)}</strong><small>s</small></span>`;
      }
      
      updateCountdown();
      const timer = setInterval(updateCountdown, 1000);
    }
    
    // Share button with toast notification
    const shareBtn = document.getElementById('sharePlan');
    if (shareBtn) {
      shareBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(window.location.href)
          .then(() => {
            showToast('âœ… Link copied to clipboard!');
          })
          .catch(() => {
            showToast('âŒ Could not copy link');
          });
      });
    }
    
    // Toast notification function
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  });
</script>